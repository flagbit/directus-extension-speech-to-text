import{defineInterface as e}from"@directus/extensions-sdk";import{defineComponent as t,ref as a,computed as n,resolveComponent as i,openBlock as o,createElementBlock as r,createElementVNode as l,createBlock as s,resolveDynamicComponent as c,createVNode as d,withCtx as p,createTextVNode as u,createCommentVNode as v,toDisplayString as h}from"vue";const m={class:"speech-to-text-interface"},f={class:"input-container"},g={class:"mic-button-container"},y={key:0},x={key:1},w={key:0,class:"warning-message"},b={key:1,class:"error-message"},k={key:2,class:"recording-indicator"};var _=t({__name:"speech-to-text",props:{value:{},placeholder:{default:"Text eingeben oder Mikrofon verwenden..."},openai_api_key:{},language:{default:"auto"},append_mode:{type:Boolean,default:!0},line_separator:{default:"auto"},type:{},field:{}},emits:["input"],setup(e,{emit:t}){const _=e,A=t,P=a(!1),S=a(!1),T=a(""),I=a(null),E=a([]),U=n((()=>_.openai_api_key)),C=n((()=>"text"===_.type||"text"===_.field?.type||_.value&&_.value.length>100));async function M(){P.value?I.value&&P.value&&(I.value.stop(),P.value=!1):await async function(){try{T.value="";const e=await navigator.mediaDevices.getUserMedia({audio:{sampleRate:16e3,channelCount:1,echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}});E.value=[];let t="audio/webm;codecs=opus";MediaRecorder.isTypeSupported(t)||(t="audio/webm",MediaRecorder.isTypeSupported(t)||(t="audio/mp4",MediaRecorder.isTypeSupported(t)||(t=""))),I.value=new MediaRecorder(e,t?{mimeType:t}:void 0),I.value.ondataavailable=e=>{e.data.size>0&&E.value.push(e.data)},I.value.onstop=async()=>{e.getTracks().forEach((e=>e.stop())),await async function(){if(0===E.value.length)return void(T.value="No audio data recorded. Please try again.");try{S.value=!0,T.value="";const e=new Blob(E.value,{type:E.value[0].type});if(e.size>26214400)return void(T.value="Audio file too large. Please record shorter audio clips.");const t=await e.arrayBuffer();let a;try{const e=new AudioContext;a=function(e){const t=Math.min(e.numberOfChannels,2),a=e.sampleRate,n=1,i=16,o=t*(i/8),r=a*o,l=e.length*o,s=new ArrayBuffer(44+l),c=new DataView(s),d=(e,t)=>{for(let a=0;a<t.length;a++)c.setUint8(e+a,t.charCodeAt(a))};d(0,"RIFF"),c.setUint32(4,36+l,!0),d(8,"WAVE"),d(12,"fmt "),c.setUint32(16,16,!0),c.setUint16(20,n,!0),c.setUint16(22,t,!0),c.setUint32(24,a,!0),c.setUint32(28,r,!0),c.setUint16(32,o,!0),c.setUint16(34,i,!0),d(36,"data"),c.setUint32(40,l,!0);let p=44;for(let a=0;a<e.length;a++)for(let n=0;n<t;n++){const t=e.getChannelData(n),i=Math.max(-1,Math.min(1,t[a]));c.setInt16(p,32767*i,!0),p+=2}return new Blob([s],{type:"audio/wav"})}(await e.decodeAudioData(t)),e.close()}catch(t){console.warn("Could not decode audio, using original blob:",t),a=e}const n=new FormData;n.append("file",a,"audio.wav"),n.append("model","whisper-1"),"auto"!==_.language&&n.append("language",_.language);const i=await fetch("https://api.openai.com/v1/audio/transcriptions",{method:"POST",headers:{Authorization:`Bearer ${U.value}`},body:n});if(!i.ok){const e=await i.json().catch((()=>null)),t=e?.error?.message||`HTTP ${i.status} ${i.statusText}`;throw new Error(`OpenAI API Error: ${t}`)}const o=await i.json();if(o.text&&o.text.trim()){const e=_.value||"";let t;if(_.append_mode&&e){let a="";switch(_.line_separator){case"space":a=e.endsWith(" ")?"":" ";break;case"newline":a=e.endsWith("\n")?"":"\n";break;case"none":a="";break;default:a=C.value?e.endsWith("\n")?"":"\n":e.endsWith(" ")||e.endsWith("\n")?"":" "}t=e+a+o.text.trim()}else t=o.text.trim();A("input",t)}else T.value="No speech detected. Please try speaking more clearly or check your microphone."}catch(e){const t=e instanceof Error?e.message:"Unknown error";t.includes("network")||t.includes("fetch")?T.value="Network error. Please check your internet connection and try again.":t.includes("API key")?T.value="Invalid API key. Please check your OpenAI API key.":T.value=`Speech recognition error: ${t}`,console.error("Speech recognition error:",e)}finally{S.value=!1}}()},I.value.onerror=t=>{console.error("MediaRecorder error:",t),T.value="Recording error occurred",e.getTracks().forEach((e=>e.stop())),P.value=!1},I.value.start(1e3),P.value=!0}catch(e){const t=e instanceof Error?e.message:"Unknown error";t.includes("Permission denied")||t.includes("NotAllowedError")?T.value="Microphone access denied. Please allow microphone permissions and try again.":t.includes("NotFoundError")?T.value="No microphone found. Please connect a microphone and try again.":T.value=`Failed to access microphone: ${t}`,console.error("Error accessing microphone:",e)}}()}return(e,t)=>{const a=i("v-button"),n=i("v-notice"),_=i("v-icon");return o(),r("div",m,[l("div",f,[(o(),s(c(C.value?"v-textarea":"v-input"),{"model-value":e.value,placeholder:e.placeholder,"onUpdate:modelValue":t[0]||(t[0]=t=>e.$emit("input",t)),disabled:P.value,trim:!1,rows:C.value?6:void 0,"expand-on-focus":!1,"auto-grow":!1,class:"speech-input"},null,8,["model-value","placeholder","disabled","rows"])),l("div",g,[d(a,{color:P.value?"danger":"primary",loading:S.value,onClick:M,small:"",disabled:!U.value,tooltip:U.value?P.value?"Stop recording":S.value?"Processing audio...":"Start voice recording":"OpenAI API Key required",class:"mic-button"},{default:p((()=>[P.value?(o(),r("span",y,"⏹")):(o(),r("span",x,"🎤"))])),_:1},8,["color","loading","disabled","tooltip"])])]),U.value?v("v-if",!0):(o(),r("div",w,[d(n,{type:"warning"},{default:p((()=>t[1]||(t[1]=[u(" OpenAI API Key is required. Please configure it in the interface options. ")]))),_:1,__:[1]})])),T.value?(o(),r("div",b,[d(n,{type:"danger"},{default:p((()=>[u(h(T.value),1)])),_:1})])):v("v-if",!0),P.value?(o(),r("div",k,[d(_,{name:"radio_button_checked",class:"recording-pulse"}),t[2]||(t[2]=l("span",null,"Recording... Click stop to finish",-1))])):v("v-if",!0)])}}}),A=[],P=[];!function(e,t){if(e&&"undefined"!=typeof document){var a,n=!0===t.prepend?"prepend":"append",i=!0===t.singleTag,o="string"==typeof t.container?document.querySelector(t.container):document.getElementsByTagName("head")[0];if(i){var r=A.indexOf(o);-1===r&&(r=A.push(o)-1,P[r]={}),a=P[r]&&P[r][n]?P[r][n]:P[r][n]=l()}else a=l();65279===e.charCodeAt(0)&&(e=e.substring(1)),a.styleSheet?a.styleSheet.cssText+=e:a.appendChild(document.createTextNode(e))}function l(){var e=document.createElement("style");if(e.setAttribute("type","text/css"),t.attributes)for(var a=Object.keys(t.attributes),i=0;i<a.length;i++)e.setAttribute(a[i],t.attributes[a[i]]);var r="prepend"===n?"afterbegin":"beforeend";return o.insertAdjacentElement(r,e),e}}("\n.speech-to-text-interface[data-v-2a5483f6] {\n  position: relative;\n}\n.input-container[data-v-2a5483f6] {\n  position: relative;\n  display: flex;\n  align-items: flex-start;\n  gap: 8px;\n}\n.speech-input[data-v-2a5483f6] {\n  flex: 1;\n}\n\n/* Force textarea to maintain consistent size */\n.speech-input[data-v-2a5483f6] .v-textarea {\n  min-height: auto !important;\n}\n.speech-input[data-v-2a5483f6] .v-textarea .v-field__input {\n  min-height: 120px !important;\n  padding-top: 12px !important;\n  padding-bottom: 12px !important;\n}\n.speech-input[data-v-2a5483f6] .v-input .v-field {\n  min-height: auto !important;\n}\n.mic-button-container[data-v-2a5483f6] {\n  display: flex;\n  align-items: flex-start;\n  padding-top: 12px;\n}\n\n/* Smaller button size */\n.mic-button[data-v-2a5483f6] {\n  min-width: 24px !important;\n  max-width: 24px !important;\n  width: 24px !important;\n  height: 24px !important;\n  padding: 0 !important;\n  margin: 0 !important;\n}\n.mic-button[data-v-2a5483f6] .v-btn__content {\n  font-size: 12px !important;\n  line-height: 1 !important;\n  padding: 0 !important;\n}\n.warning-message[data-v-2a5483f6],\n.error-message[data-v-2a5483f6] {\n  margin-top: 8px;\n}\n.recording-indicator[data-v-2a5483f6] {\n  display: flex;\n  align-items: center;\n  gap: 8px;\n  margin-top: 8px;\n  color: var(--theme--danger);\n  font-size: 14px;\n  font-weight: 500;\n}\n.recording-pulse[data-v-2a5483f6] {\n  animation: pulse-2a5483f6 1.5s ease-in-out infinite;\n}\n@keyframes pulse-2a5483f6 {\n0%, 100% { \n    opacity: 1;\n    transform: scale(1);\n}\n50% { \n    opacity: 0.6;\n    transform: scale(1.1);\n}\n}\n\n/* Dark mode compatibility */\n@media (prefers-color-scheme: dark) {\n.recording-indicator[data-v-2a5483f6] {\n    color: var(--theme--danger);\n}\n}\n",{});var S=e({id:"speech-to-text",name:"Speech to Text",description:"Text input with speech-to-text functionality using OpenAI Whisper",icon:"mic",component:((e,t)=>{const a=e.__vccOpts||e;for(const[e,n]of t)a[e]=n;return a})(_,[["__scopeId","data-v-2a5483f6"],["__file","speech-to-text.vue"]]),types:["string","text"],group:"standard",options:[{field:"placeholder",name:"Placeholder",type:"string",meta:{width:"half",interface:"input",options:{placeholder:"Enter placeholder text..."}},schema:{default_value:"Text eingeben oder Mikrofon verwenden..."}},{field:"openai_api_key",name:"OpenAI API Key",type:"string",meta:{width:"full",interface:"input",options:{masked:!0}}},{field:"language",name:"Language",type:"string",meta:{width:"half",interface:"select-dropdown",options:{choices:[{text:"Auto-detect",value:"auto"},{text:"German",value:"de"},{text:"English",value:"en"},{text:"Spanish",value:"es"},{text:"French",value:"fr"},{text:"Italian",value:"it"},{text:"Portuguese",value:"pt"},{text:"Russian",value:"ru"},{text:"Japanese",value:"ja"},{text:"Chinese",value:"zh"}]}},schema:{default_value:"auto"}},{field:"append_mode",name:"Append Mode",type:"boolean",meta:{width:"half",interface:"boolean",options:{label:"Append to existing text (instead of replacing)"}},schema:{default_value:!0}},{field:"line_separator",name:"Text Separator",type:"string",meta:{width:"half",interface:"select-dropdown",options:{choices:[{text:"Auto (Space for input, Newline for textarea)",value:"auto"},{text:"Space",value:"space"},{text:"New Line",value:"newline"},{text:"No Separator",value:"none"}]}},schema:{default_value:"auto"}}],preview:'<svg width="156" height="96" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="18" y="15" width="120" height="66" rx="6" fill="var(--theme--background)" class="glow" /><rect x="19" y="16" width="118" height="64" rx="5" stroke="var(--theme--primary)" stroke-width="2" /><circle cx="40" cy="48" r="12" fill="var(--theme--primary)" fill-opacity=".25" /><circle cx="40" cy="48" r="8" fill="var(--theme--primary)" /><rect x="60" y="40" width="60" height="6" rx="2" fill="var(--theme--primary)" fill-opacity=".25" /><rect x="60" y="50" width="40" height="6" rx="2" fill="var(--theme--primary)" fill-opacity=".25" /></svg>'});export{S as default};
